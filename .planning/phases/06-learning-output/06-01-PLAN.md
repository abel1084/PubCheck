---
phase: 06-learning-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/learning/__init__.py
  - backend/app/learning/models.py
  - backend/app/learning/service.py
  - backend/app/learning/router.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "Ignored rules can be added via POST /api/ignored-rules"
    - "Ignored rules can be retrieved via GET /api/ignored-rules"
    - "Ignored rules can be deleted via DELETE /api/ignored-rules/{rule_id}/{doc_type}"
    - "Ignored rules persist to JSON file across server restarts"
  artifacts:
    - path: "backend/app/learning/models.py"
      provides: "IgnoredRule and IgnoredRulesConfig Pydantic models"
      exports: ["IgnoredRule", "IgnoredRulesConfig"]
    - path: "backend/app/learning/service.py"
      provides: "IgnoredRulesService with atomic file persistence"
      exports: ["IgnoredRulesService"]
    - path: "backend/app/learning/router.py"
      provides: "REST endpoints for ignored rules CRUD"
      exports: ["router"]
  key_links:
    - from: "backend/app/learning/router.py"
      to: "backend/app/learning/service.py"
      via: "dependency injection"
      pattern: "IgnoredRulesService"
    - from: "backend/app/main.py"
      to: "backend/app/learning/router.py"
      via: "include_router"
      pattern: "app\\.include_router\\(learning_router\\)"
---

<objective>
Create backend learning module for ignored rules persistence.

Purpose: Enable users to mark rules as ignored per document type, persisted to JSON file for subsequent reviews.
Output: Learning service with CRUD API endpoints for ignored rules.
</objective>

<execution_context>
@C:\Users\abelb\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abelb\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-learning-output/06-CONTEXT.md
@.planning/phases/06-learning-output/06-RESEARCH.md

# Existing patterns to follow
@backend/app/config/service.py (atomic file write pattern)
@backend/app/config/models.py (Pydantic model pattern)
@backend/app/main.py (router registration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create learning models and service</name>
  <files>
    backend/app/learning/__init__.py
    backend/app/learning/models.py
    backend/app/learning/service.py
  </files>
  <action>
Create the learning module structure:

1. Create `backend/app/learning/__init__.py` with empty file or basic docstring.

2. Create `backend/app/learning/models.py` with Pydantic models:
   - `IgnoredRule`: rule_id (str), document_type (str), reason (Optional[str]), added_date (str ISO format)
   - `IgnoredRulesConfig`: version (str = "1.0"), ignored (List[IgnoredRule] = [])
   - Use Pydantic v1 compatible syntax (no model_validator)

3. Create `backend/app/learning/service.py` with `IgnoredRulesService`:
   - Store in `backend/user_config/ignored_rules.json`
   - `load()` method: Load from file or return empty config if not exists
   - `save(config)` method: Atomic write using tempfile + os.replace pattern from config/service.py
   - `add_rule(rule_id, document_type, reason)` method: Add rule, save, return updated list
   - `remove_rule(rule_id, document_type)` method: Remove matching rule, save, return success bool
   - `get_ignored_for_doc_type(document_type)` method: Return list of rule_ids for filtering

Pattern from config/service.py for atomic writes:
```python
fd, temp_path = tempfile.mkstemp(dir=file_path.parent, suffix=".json")
try:
    with os.fdopen(fd, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=2)
    os.replace(temp_path, file_path)
except Exception:
    if os.path.exists(temp_path):
        os.unlink(temp_path)
    raise
```
  </action>
  <verify>
    - Python imports successfully: `python -c "from app.learning.models import IgnoredRule, IgnoredRulesConfig; from app.learning.service import IgnoredRulesService"`
  </verify>
  <done>
    - IgnoredRule and IgnoredRulesConfig models exist with correct fields
    - IgnoredRulesService can load, save, add, remove rules with atomic persistence
  </done>
</task>

<task type="auto">
  <name>Task 2: Create learning API router and register</name>
  <files>
    backend/app/learning/router.py
    backend/app/main.py
  </files>
  <action>
1. Create `backend/app/learning/router.py`:
   - Create APIRouter with prefix="/api/ignored-rules" and tags=["learning"]
   - Singleton service instance at module level: `_service = IgnoredRulesService()`

   Endpoints:
   - `GET /` -> List[IgnoredRule]: Return all ignored rules
   - `GET /{document_type}` -> List[str]: Return rule_ids ignored for specific doc type
   - `POST /` with body {rule_id, document_type, reason?} -> IgnoredRule: Add new ignored rule
   - `DELETE /{rule_id}/{document_type}` -> {success: bool}: Remove ignored rule

   Add proper response models and HTTP status codes (201 for POST, 404 if rule not found on DELETE).

2. Update `backend/app/main.py`:
   - Import: `from app.learning.router import router as learning_router`
   - Add: `app.include_router(learning_router)`
  </action>
  <verify>
    - Start server and test endpoints:
      - `curl http://localhost:8003/api/ignored-rules` returns []
      - `curl -X POST http://localhost:8003/api/ignored-rules -H "Content-Type: application/json" -d '{"rule_id":"test-rule","document_type":"factsheet"}' returns 201 with IgnoredRule
      - `curl http://localhost:8003/api/ignored-rules` returns the added rule
      - `curl -X DELETE http://localhost:8003/api/ignored-rules/test-rule/factsheet` returns {success: true}
  </verify>
  <done>
    - All four endpoints functional
    - Rules persist to backend/user_config/ignored_rules.json
    - Router registered in main.py
  </done>
</task>

</tasks>

<verification>
- [ ] `python -c "from app.learning.service import IgnoredRulesService"` succeeds
- [ ] Server starts without errors: `cd backend && python -m uvicorn app.main:app --port 8003`
- [ ] GET /api/ignored-rules returns empty array initially
- [ ] POST /api/ignored-rules creates rule and persists to file
- [ ] GET /api/ignored-rules/{doc_type} returns rule_ids for filtering
- [ ] DELETE /api/ignored-rules/{rule_id}/{doc_type} removes rule
</verification>

<success_criteria>
- Backend learning module complete with models, service, and router
- Atomic file persistence to user_config/ignored_rules.json
- All CRUD endpoints functional and tested
</success_criteria>

<output>
After completion, create `.planning/phases/06-learning-output/06-01-SUMMARY.md`
</output>
