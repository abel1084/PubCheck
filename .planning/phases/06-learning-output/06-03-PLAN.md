---
phase: 06-learning-output
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - frontend/src/types/learning.ts
  - frontend/src/hooks/useIgnoredRules.ts
  - frontend/src/components/Toast/ToastProvider.tsx
  - frontend/src/components/CheckResults/IssueCard.tsx
  - frontend/src/App.tsx
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "User can click ignore button on an issue card"
    - "Toast appears with 'Rule ignored' message and Undo button"
    - "Clicking Undo restores the rule"
    - "Ignored rules state syncs with backend API"
  artifacts:
    - path: "frontend/src/types/learning.ts"
      provides: "IgnoredRule and IgnoredRulesConfig TypeScript types"
      exports: ["IgnoredRule", "IgnoredRulesConfig"]
    - path: "frontend/src/hooks/useIgnoredRules.ts"
      provides: "Hook for ignored rules state and API operations"
      exports: ["useIgnoredRules"]
    - path: "frontend/src/components/Toast/ToastProvider.tsx"
      provides: "Sonner Toaster component wrapper"
      exports: ["ToastProvider"]
  key_links:
    - from: "frontend/src/components/CheckResults/IssueCard.tsx"
      to: "sonner"
      via: "toast function import"
      pattern: "import.*toast.*from.*sonner"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/Toast/ToastProvider.tsx"
      via: "ToastProvider component"
      pattern: "<ToastProvider"
---

<objective>
Create frontend learning integration with ignore button and toast notifications.

Purpose: Enable users to ignore rules from the issue card UI with undo capability via toast.
Output: Ignore button on IssueCard, Sonner toast integration, useIgnoredRules hook.
</objective>

<execution_context>
@C:\Users\abelb\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abelb\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-learning-output/06-CONTEXT.md
@.planning/phases/06-learning-output/06-RESEARCH.md

# Existing patterns
@frontend/src/hooks/useRuleSettings.ts (hook pattern with API calls)
@frontend/src/components/CheckResults/IssueCard.tsx (component to modify)
@frontend/src/App.tsx (provider integration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sonner and create types/hook</name>
  <files>
    frontend/package.json
    frontend/src/types/learning.ts
    frontend/src/hooks/useIgnoredRules.ts
    frontend/src/components/Toast/ToastProvider.tsx
  </files>
  <action>
1. Install Sonner:
   `cd frontend && npm install sonner`

2. Create `frontend/src/types/learning.ts`:
```typescript
/**
 * TypeScript types for the learning system (ignored rules).
 */

export interface IgnoredRule {
  rule_id: string;
  document_type: string;
  reason?: string;
  added_date: string;
}

export interface IgnoredRulesConfig {
  version: string;
  ignored: IgnoredRule[];
}
```

3. Create `frontend/src/hooks/useIgnoredRules.ts`:
```typescript
import { useState, useCallback, useEffect } from 'react';
import type { IgnoredRule } from '../types/learning';

interface UseIgnoredRulesReturn {
  ignoredRules: IgnoredRule[];
  ignoredRuleIds: Set<string>;  // For quick lookup by rule_id (doc-type scoped)
  loading: boolean;
  error: string | null;
  ignoreRule: (ruleId: string, documentType: string, reason?: string) => Promise<void>;
  unignoreRule: (ruleId: string, documentType: string) => Promise<void>;
  refresh: () => Promise<void>;
}

export function useIgnoredRules(documentType: string | null): UseIgnoredRulesReturn {
  const [ignoredRules, setIgnoredRules] = useState<IgnoredRule[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Set of rule_ids ignored for current document type
  const ignoredRuleIds = new Set(
    ignoredRules
      .filter(r => r.document_type === documentType)
      .map(r => r.rule_id)
  );

  const fetchIgnoredRules = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch('/api/ignored-rules');
      if (!response.ok) throw new Error('Failed to fetch ignored rules');
      const data = await response.json();
      setIgnoredRules(data);
    } catch (e) {
      setError(e instanceof Error ? e.message : 'Unknown error');
    } finally {
      setLoading(false);
    }
  }, []);

  const ignoreRule = useCallback(async (ruleId: string, docType: string, reason?: string) => {
    const response = await fetch('/api/ignored-rules', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ rule_id: ruleId, document_type: docType, reason }),
    });
    if (!response.ok) throw new Error('Failed to ignore rule');
    const newRule = await response.json();
    setIgnoredRules(prev => [...prev, newRule]);
  }, []);

  const unignoreRule = useCallback(async (ruleId: string, docType: string) => {
    const response = await fetch(`/api/ignored-rules/${encodeURIComponent(ruleId)}/${encodeURIComponent(docType)}`, {
      method: 'DELETE',
    });
    if (!response.ok) throw new Error('Failed to unignore rule');
    setIgnoredRules(prev => prev.filter(r => !(r.rule_id === ruleId && r.document_type === docType)));
  }, []);

  useEffect(() => {
    fetchIgnoredRules();
  }, [fetchIgnoredRules]);

  return {
    ignoredRules,
    ignoredRuleIds,
    loading,
    error,
    ignoreRule,
    unignoreRule,
    refresh: fetchIgnoredRules,
  };
}
```

4. Create `frontend/src/components/Toast/ToastProvider.tsx`:
```typescript
import { Toaster } from 'sonner';

/**
 * Toast notification provider using Sonner.
 * Positioned at bottom-right with 5-second default duration.
 */
export function ToastProvider() {
  return (
    <Toaster
      position="bottom-right"
      expand={false}
      richColors
      duration={5000}
    />
  );
}
```
  </action>
  <verify>
    - `cd frontend && npm ls sonner` shows sonner installed
    - TypeScript compiles: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
    - Sonner installed as dependency
    - learning.ts types exported
    - useIgnoredRules hook with CRUD operations
    - ToastProvider component ready
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ignore button to IssueCard and integrate ToastProvider</name>
  <files>
    frontend/src/components/CheckResults/IssueCard.tsx
    frontend/src/components/CheckResults/CheckResults.css
    frontend/src/App.tsx
  </files>
  <action>
1. Update `frontend/src/components/CheckResults/IssueCard.tsx`:
   - Add new prop: `onIgnoreRule?: (ruleId: string) => void`
   - Add ignore button in the card header (next to severity badge), small icon/button
   - Button shows on hover, uses title="Ignore this rule for this document type"
   - On click: call `onIgnoreRule(issue.rule_id)`
   - Only show button in review mode (when onIgnoreRule is provided)

Add button markup after severity badge:
```tsx
{onIgnoreRule && (
  <button
    type="button"
    className="issue-card__ignore-btn"
    onClick={(e) => {
      e.stopPropagation();
      onIgnoreRule(issue.rule_id);
    }}
    title="Ignore this rule for this document type"
    aria-label={`Ignore rule ${issue.rule_id}`}
  >
    <span aria-hidden="true">&#10005;</span>
  </button>
)}
```

2. Add CSS to `frontend/src/components/CheckResults/CheckResults.css`:
```css
/* Ignore button */
.issue-card__ignore-btn {
  background: transparent;
  border: 1px solid #ccc;
  border-radius: 3px;
  padding: 2px 6px;
  font-size: 0.75rem;
  color: #666;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.15s, background-color 0.15s;
  margin-left: auto;
}

.issue-card:hover .issue-card__ignore-btn,
.issue-card__summary:focus .issue-card__ignore-btn {
  opacity: 1;
}

.issue-card__ignore-btn:hover {
  background-color: #f8d7da;
  border-color: #dc3545;
  color: #dc3545;
}
```

3. Update `frontend/src/App.tsx`:
   - Import `ToastProvider` from './components/Toast/ToastProvider'
   - Add `<ToastProvider />` as first child in the return JSX (before other content)
  </action>
  <verify>
    - TypeScript compiles: `cd frontend && npx tsc --noEmit`
    - Start frontend and visually verify ignore button appears on issue cards when hovering
  </verify>
  <done>
    - IssueCard has ignore button (X icon) that appears on hover
    - onIgnoreRule callback prop wired
    - ToastProvider integrated in App.tsx
    - CSS styling for ignore button
  </done>
</task>

</tasks>

<verification>
- [ ] `npm ls sonner` shows installed
- [ ] TypeScript compiles without errors
- [ ] ToastProvider rendered in App.tsx
- [ ] Ignore button visible on issue card hover
- [ ] useIgnoredRules hook can fetch/add/remove rules via API
</verification>

<success_criteria>
- Sonner toast library installed and provider integrated
- useIgnoredRules hook complete with API operations
- IssueCard has ignore button with proper styling
- All types exported and TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/06-learning-output/06-03-SUMMARY.md`
</output>
