---
phase: 07-ai-first-architecture
plan: 06
type: execute
wave: 3
depends_on: ["07-04"]
files_modified:
  - backend/app/ai/router.py
  - backend/app/ai/__init__.py
autonomous: true

must_haves:
  truths:
    - "POST /api/ai/review endpoint accepts PDF file and extraction"
    - "Response streams via Server-Sent Events"
    - "Each text chunk sent as SSE data event"
    - "Complete event sent when stream finishes"
  artifacts:
    - path: "backend/app/ai/router.py"
      provides: "Streaming review endpoint"
      min_lines: 50
      contains: "EventSourceResponse"
    - path: "backend/app/ai/__init__.py"
      provides: "AI module exports"
  key_links:
    - from: "backend/app/ai/router.py"
      to: "backend/app/ai/reviewer.py"
      via: "review_document import"
      pattern: "from .reviewer import review_document"
    - from: "backend/app/ai/router.py"
      to: "sse-starlette"
      via: "EventSourceResponse"
      pattern: "from sse_starlette"
---

<objective>
Create the streaming SSE review endpoint that sends AI responses in real-time.

Purpose: Implement the API endpoint (ARCH-03, ARCH-04) that accepts PDF + extraction + document type and streams the AI review response via Server-Sent Events.

Output: Updated router.py with streaming /api/ai/review endpoint using sse-starlette.
</objective>

<execution_context>
@C:\Users\abelb\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abelb\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-ai-first-architecture/07-CONTEXT.md
@.planning/phases/07-ai-first-architecture/07-RESEARCH.md
@.planning/phases/07-ai-first-architecture/07-04-SUMMARY.md
@backend/app/ai/router.py
@backend/app/ai/reviewer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite AI router with streaming endpoint</name>
  <files>backend/app/ai/router.py</files>
  <action>
Completely rewrite `backend/app/ai/router.py` to implement the streaming review endpoint:

```python
"""
REST API router for AI-powered document review.
Streams review response via Server-Sent Events.
"""
import json
import logging
import os
import tempfile
import traceback
from typing import AsyncGenerator

from fastapi import APIRouter, File, Form, HTTPException, UploadFile
from sse_starlette import EventSourceResponse

from app.models.extraction import ExtractionResult

from .client import AIClientError, AIConfigurationError
from .reviewer import review_document


logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/ai", tags=["ai"])


async def generate_review_events(
    pdf_bytes: bytes,
    extraction: ExtractionResult,
    document_type: str,
    confidence: float,
) -> AsyncGenerator[dict, None]:
    """
    Generate SSE events from AI review stream.

    Yields:
        SSE event dicts with 'event' and 'data' keys
    """
    try:
        async for text_chunk in review_document(
            pdf_bytes=pdf_bytes,
            extraction=extraction,
            document_type=document_type,
            confidence=confidence,
        ):
            yield {
                "event": "text",
                "data": json.dumps({"text": text_chunk}),
            }

        # Send completion event
        yield {
            "event": "complete",
            "data": json.dumps({"status": "complete"}),
        }

    except AIConfigurationError as e:
        logger.error(f"AI configuration error: {e}")
        yield {
            "event": "error",
            "data": json.dumps({"error": str(e), "type": "configuration"}),
        }

    except AIClientError as e:
        logger.error(f"AI client error: {e}")
        yield {
            "event": "error",
            "data": json.dumps({"error": str(e), "type": "api"}),
        }

    except Exception as e:
        logger.error(f"Unexpected error in review: {e}")
        logger.error(traceback.format_exc())
        yield {
            "event": "error",
            "data": json.dumps({"error": str(e), "type": "unknown"}),
        }


@router.post("/review")
async def review_pdf(
    file: UploadFile = File(...),
    extraction: str = Form(...),
    document_type: str = Form(...),
    confidence: float = Form(...),
):
    """
    Stream AI document review via Server-Sent Events.

    Receives PDF file and extraction data, streams review text chunks.

    Args:
        file: The PDF file to review
        extraction: JSON string of ExtractionResult
        document_type: Type of document (factsheet, publication, etc.)
        confidence: Document type detection confidence (0-1)

    Returns:
        EventSourceResponse streaming text chunks

    SSE Events:
        - text: {"text": "chunk of review text"}
        - complete: {"status": "complete"}
        - error: {"error": "message", "type": "configuration|api|unknown"}
    """
    tmp_path = None
    try:
        logger.info(f"Review request: document_type={document_type}, confidence={confidence}")
        logger.info(f"File: {file.filename}, content_type={file.content_type}")

        # Validate document_type
        valid_types = ["factsheet", "policy-brief", "issue-note", "working-paper", "publication"]
        if document_type not in valid_types:
            raise HTTPException(
                status_code=400,
                detail=f"Invalid document_type: {document_type}. Must be one of: {valid_types}"
            )

        # Parse extraction JSON
        try:
            extraction_data = ExtractionResult.model_validate_json(extraction)
        except Exception as e:
            raise HTTPException(
                status_code=400,
                detail=f"Invalid extraction JSON: {e}"
            )

        logger.info(f"Extraction parsed: {extraction_data.metadata.page_count} pages")

        # Read PDF bytes
        pdf_bytes = await file.read()
        logger.info(f"PDF size: {len(pdf_bytes)} bytes")

        # Return streaming response
        return EventSourceResponse(
            generate_review_events(
                pdf_bytes=pdf_bytes,
                extraction=extraction_data,
                document_type=document_type,
                confidence=confidence,
            ),
            media_type="text/event-stream",
        )

    except HTTPException:
        raise

    except Exception as e:
        logger.error(f"Unexpected error in review endpoint: {e}")
        logger.error(traceback.format_exc())
        raise HTTPException(status_code=500, detail=f"Review failed: {str(e)}")


# Keep old analyze endpoint for backward compatibility during transition
# TODO: Remove after frontend migration complete
@router.post("/analyze")
async def analyze_pdf_deprecated(
    file: UploadFile = File(...),
    extraction_file: UploadFile = File(...),
    document_type: str = Form(...),
):
    """
    DEPRECATED: Use /review endpoint instead.
    Kept for backward compatibility during Phase 7 transition.
    """
    raise HTTPException(
        status_code=410,
        detail="This endpoint is deprecated. Use POST /api/ai/review instead."
    )
```

**Key features:**
- SSE streaming: Uses sse-starlette EventSourceResponse
- Event types: text (content), complete (done), error (failures)
- Extraction as Form field: JSON string, not separate file
- Error handling: Yields error events instead of throwing
- Backward compat: Old /analyze endpoint returns 410 Gone
  </action>
  <verify>
- File contains /review endpoint with EventSourceResponse
- generate_review_events function yields SSE event dicts
- `python -c "from app.ai.router import router; print('OK')"`
- Error events yield with error type classification
  </verify>
  <done>
- Streaming review endpoint implemented
- SSE events: text, complete, error
- Backward compatibility stub for old endpoint
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AI module exports</name>
  <files>backend/app/ai/__init__.py</files>
  <action>
Update `backend/app/ai/__init__.py` to export the new modules:

```python
"""
AI module for document review.
Provides Claude-powered document analysis with native PDF support.
"""
from .client import AIClient, AIClientError, AIConfigurationError, get_ai_client
from .reviewer import review_document, load_rules_context
from .prompts import build_system_prompt, build_user_prompt
from .schemas import ReviewRequest, ReviewMetadata

__all__ = [
    # Client
    "AIClient",
    "AIClientError",
    "AIConfigurationError",
    "get_ai_client",
    # Reviewer
    "review_document",
    "load_rules_context",
    # Prompts
    "build_system_prompt",
    "build_user_prompt",
    # Schemas
    "ReviewRequest",
    "ReviewMetadata",
]
```
  </action>
  <verify>
- File exports all new modules
- `python -c "from app.ai import review_document, get_ai_client; print('OK')"`
  </verify>
  <done>
- AI module exports updated
- All new functions accessible via app.ai
  </done>
</task>

</tasks>

<verification>
1. Router file contains streaming endpoint with EventSourceResponse
2. `python -c "from app.ai.router import router; from sse_starlette import EventSourceResponse; print('OK')"`
3. __init__.py exports all new functions
4. Old /analyze endpoint returns 410
</verification>

<success_criteria>
- POST /api/ai/review streams SSE events
- Text chunks yield as they're generated
- Complete event sent at end
- Error events for failures
</success_criteria>

<output>
After completion, create `.planning/phases/07-ai-first-architecture/07-06-SUMMARY.md`
</output>
