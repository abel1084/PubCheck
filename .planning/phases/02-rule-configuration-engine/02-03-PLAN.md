---
phase: 02-rule-configuration-engine
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - frontend/src/types/rules.ts
  - frontend/src/hooks/useRuleSettings.ts
  - frontend/src/hooks/useUnsavedChangesWarning.ts
  - frontend/src/components/Settings/Settings.tsx
  - frontend/src/components/Settings/Settings.css
  - frontend/src/components/Settings/RuleCategory.tsx
  - frontend/src/components/Settings/RuleRow.tsx
  - frontend/src/App.tsx
  - frontend/src/App.css
autonomous: true

must_haves:
  truths:
    - "User can see Settings with 5 document type tabs"
    - "User can see rules grouped by collapsible categories"
    - "User can toggle rules on/off with checkbox"
    - "User can switch severity between Error/Warning"
    - "User can save changes with explicit Save button"
    - "User can reset to defaults"
    - "Unsaved changes warning appears when leaving"
  artifacts:
    - path: "frontend/src/types/rules.ts"
      provides: "TypeScript types for rules"
      exports: ["Rule", "Category", "Template", "DocumentTypeId"]
    - path: "frontend/src/hooks/useRuleSettings.ts"
      provides: "Settings state management hook"
      exports: ["useRuleSettings"]
    - path: "frontend/src/components/Settings/Settings.tsx"
      provides: "Main Settings component with tabs"
      exports: ["Settings"]
  key_links:
    - from: "frontend/src/hooks/useRuleSettings.ts"
      to: "/api/rules"
      via: "fetch in useEffect"
      pattern: "fetch.*api/rules"
    - from: "frontend/src/components/Settings/Settings.tsx"
      to: "frontend/src/hooks/useRuleSettings.ts"
      via: "useRuleSettings hook"
      pattern: "useRuleSettings"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/Settings/Settings.tsx"
      via: "Settings component import"
      pattern: "import.*Settings"
---

<objective>
Create the complete Settings UI for rule configuration with document type tabs, collapsible categories, and rule editing controls.

Purpose: Enable users to view and configure compliance rules per document type through an intuitive settings interface with proper state management and persistence.

Output: Complete Settings UI with tabs, categories, rule toggling, severity switching, save/reset functionality, and unsaved changes warning.
</objective>

<execution_context>
@C:\Users\abelb\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abelb\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-rule-configuration-engine/02-CONTEXT.md
@.planning/phases/02-rule-configuration-engine/02-RESEARCH.md

# API contract from 02-02
@backend/app/config/router.py
@backend/app/config/models.py

# Existing frontend patterns
@frontend/src/App.tsx
@frontend/src/App.css
@frontend/src/components/DataTabs/DataTabs.tsx
@frontend/src/hooks/useExtraction.ts
@frontend/src/types/extraction.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript types and state management hook</name>
  <files>
    frontend/src/types/rules.ts
    frontend/src/hooks/useRuleSettings.ts
    frontend/src/hooks/useUnsavedChangesWarning.ts
  </files>
  <action>
**frontend/src/types/rules.ts**
Define types mirroring backend Pydantic models:
- `DocumentTypeId = "factsheet" | "policy-brief" | "issue-note" | "working-paper" | "publication"`
- `Severity = "error" | "warning"`
- `RuleExpected` - Record<string, unknown> for flexible expected values
- `Rule` - name, description, enabled, severity, check_type, expected
- `Category` - name, rules (Record<string, Rule>)
- `Template` - version, document_type, categories (Record<string, Category>)
- `RuleOverride` - Partial rule fields for user customizations

**frontend/src/hooks/useRuleSettings.ts**
Create hook using useReducer pattern from RESEARCH.md:

State:
- `rules: Template | null`
- `originalRules: Template | null`
- `isLoading: boolean`
- `isDirty: boolean`
- `isSaving: boolean`
- `saveStatus: 'idle' | 'saving' | 'saved' | 'error'`

Actions:
- LOAD - set rules and originalRules
- TOGGLE_ENABLED - toggle rule.enabled
- SET_SEVERITY - set rule.severity
- UPDATE_EXPECTED - update rule.expected field
- SAVE_START / SAVE_SUCCESS / SAVE_ERROR
- RESET - restore to originalRules

Exports:
- rules, isLoading, isDirty, isSaving, saveStatus
- toggleRule(categoryId, ruleId)
- setSeverity(categoryId, ruleId, severity)
- updateExpected(categoryId, ruleId, field, value)
- save()
- reset()
- reload()

**frontend/src/hooks/useUnsavedChangesWarning.ts**
Hook that adds beforeunload handler when isDirty is true.
  </action>
  <verify>
TypeScript compilation:
cd frontend && npm run build -- --noEmit
  </verify>
  <done>Types compile without errors, hooks export expected functions</done>
</task>

<task type="auto">
  <name>Task 2: Create Settings UI components</name>
  <files>
    frontend/src/components/Settings/Settings.tsx
    frontend/src/components/Settings/Settings.css
    frontend/src/components/Settings/RuleCategory.tsx
    frontend/src/components/Settings/RuleRow.tsx
  </files>
  <action>
**Settings.tsx** - Main settings container:
- Document type tabs at top (5 tabs: Factsheet, Policy Brief, Issue Note, Working Paper, Report/Publication)
- Tab styling: horizontal tabs, active tab highlighted
- Content area shows rules for selected document type
- Footer with Save button (disabled when not dirty), Reset button
- Save button shows "Saved" briefly on success (use saveStatus)
- Use useRuleSettings hook for state management
- Use useUnsavedChangesWarning hook

**RuleCategory.tsx** - Collapsible category section:
- Use native HTML details/summary element (from RESEARCH.md)
- Header shows: category name + enabled count (e.g., "Typography (8/12 enabled)")
- Content contains RuleRow for each rule in category
- BEM CSS naming: .rule-category, .rule-category__header, .rule-category__content

**RuleRow.tsx** - Individual rule display:
- Row shows: checkbox (enabled), rule name + expected value summary, severity toggle
- Checkbox for enable/disable
- Severity toggle button: shows "Error" or "Warning", click to switch
- When disabled, severity control should be grayed out but visible
- Click rule name to expand and show editable expected fields (future: for now just show as text)
- BEM CSS naming: .rule-row, .rule-row__checkbox, .rule-row__name, .rule-row__severity

**Settings.css**:
- Tab styling (horizontal, active state)
- Category collapsible styling
- Rule row layout (flex, spacing)
- Save/Reset button styling
- Disabled state styling
- Follow existing BEM patterns from App.css
  </action>
  <verify>
cd frontend && npm run build
  </verify>
  <done>Settings components render without errors, styling matches existing app patterns</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Settings into App</name>
  <files>
    frontend/src/App.tsx
    frontend/src/App.css
  </files>
  <action>
Add Settings access to the application:

**App.tsx changes:**
- Add state: `showSettings: boolean` (default false)
- Add "Settings" button in header (gear icon or text)
- When showSettings is true, render Settings component instead of main content
- Settings component receives onClose callback to hide settings
- Ensure settings button is visible in both upload and results views

**App.css changes:**
- Style settings button in header
- Add any necessary layout adjustments for settings overlay/view

The settings should be a separate view (not a modal) - when open, it replaces the main content area. User clicks "Close" or a back button to return to the main view.
  </action>
  <verify>
cd frontend && npm run build && npm run dev
# Manually verify: Click Settings button, see tabs, toggle a rule, save, close, reopen to verify persistence
  </verify>
  <done>Settings accessible from main app, full flow works</done>
</task>

</tasks>

<verification>
1. Settings button visible in app header
2. Clicking Settings shows 5 document type tabs
3. Each tab shows rules grouped by collapsible categories
4. Category headers show enabled count
5. Rules can be toggled on/off
6. Severity can be switched between Error/Warning
7. Save button saves changes (verify via API call in Network tab)
8. Reset button restores defaults
9. Unsaved changes warning appears when navigating away with dirty state
10. Changes persist after page refresh
</verification>

<success_criteria>
- Complete Settings UI functional
- All 4 requirements covered (CONF-01 through CONF-04)
- State management follows useReducer pattern
- UI follows existing BEM CSS patterns
- Unsaved changes protection works
</success_criteria>

<output>
After completion, create `.planning/phases/02-rule-configuration-engine/02-03-SUMMARY.md`
</output>
