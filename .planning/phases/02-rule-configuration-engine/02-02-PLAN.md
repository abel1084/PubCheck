---
phase: 02-rule-configuration-engine
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/app/config/service.py
  - backend/app/config/router.py
  - backend/app/main.py
  - backend/user_config/.gitkeep
autonomous: true

must_haves:
  truths:
    - "GET /api/rules/{document_type} returns merged rules (defaults + overrides)"
    - "PUT /api/rules/{document_type} saves user overrides"
    - "POST /api/rules/{document_type}/reset deletes user overrides"
    - "User overrides are stored separately from default templates"
  artifacts:
    - path: "backend/app/config/service.py"
      provides: "Rule loading, merging, and persistence logic"
      exports: ["RuleService"]
    - path: "backend/app/config/router.py"
      provides: "REST endpoints for rules CRUD"
      exports: ["router"]
    - path: "backend/user_config/.gitkeep"
      provides: "Directory for user override files"
  key_links:
    - from: "backend/app/config/router.py"
      to: "backend/app/config/service.py"
      via: "RuleService dependency"
      pattern: "rule_service\\."
    - from: "backend/app/main.py"
      to: "backend/app/config/router.py"
      via: "router include"
      pattern: "include_router.*config"
---

<objective>
Create the rules service layer and REST API endpoints for managing rule configurations.

Purpose: Enable the frontend to fetch, modify, and persist rule configurations per document type. User overrides are stored separately from default templates to support "reset to defaults" functionality.

Output: RuleService class with load/save/merge logic, plus FastAPI router with GET/PUT/POST endpoints for rules management.
</objective>

<execution_context>
@C:\Users\abelb\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abelb\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-rule-configuration-engine/02-CONTEXT.md
@.planning/phases/02-rule-configuration-engine/02-RESEARCH.md

# Models from 02-01
@backend/app/config/models.py

# Existing API patterns
@backend/app/api/upload.py
@backend/app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rules service with load/save/merge logic</name>
  <files>
    backend/app/config/service.py
    backend/user_config/.gitkeep
  </files>
  <action>
Create RuleService class that handles:

1. **Template mapping** - Map 5 document types to 3 base templates:
   - factsheet -> factsheet.yaml
   - policy-brief -> brief.yaml
   - issue-note -> brief.yaml
   - working-paper -> publication.yaml
   - publication -> publication.yaml

2. **Load template** - Load base YAML template using yaml.safe_load + Pydantic validation

3. **Load user overrides** - Load from user_config/{document_type}.yaml if exists

4. **Merge overrides** - Apply user overrides on top of template defaults:
   - For each override, update the corresponding rule field
   - Only override fields that are explicitly set (not None)

5. **Save overrides** - Atomic write to user_config/{document_type}.yaml:
   - Use tempfile + os.replace pattern from RESEARCH.md
   - Only save fields that differ from defaults

6. **Reset to defaults** - Delete user override file if exists

7. **Compute overrides** - Given current state and original, compute minimal diff for storage

Create `backend/user_config/.gitkeep` to ensure directory exists but contents are ignored (add to .gitignore).

Use DocumentTypeId = Literal["factsheet", "policy-brief", "issue-note", "working-paper", "publication"] for type safety.
  </action>
  <verify>
python -c "
from app.config.service import RuleService
service = RuleService()
rules = service.get_merged_rules('factsheet')
print(f'Loaded {len(rules.categories)} categories for factsheet')
"
  </verify>
  <done>RuleService can load templates and merge overrides</done>
</task>

<task type="auto">
  <name>Task 2: Create REST API endpoints for rules</name>
  <files>
    backend/app/config/router.py
    backend/app/main.py
  </files>
  <action>
Create FastAPI router with three endpoints:

**GET /api/rules/{document_type}**
- Returns merged rules (template + user overrides) as JSON
- Uses RuleService.get_merged_rules()
- Response is Template model serialized to dict

**PUT /api/rules/{document_type}**
- Accepts UserOverrides in request body
- Saves to user_config/{document_type}.yaml
- Returns {"status": "saved"}

**POST /api/rules/{document_type}/reset**
- Deletes user override file
- Returns {"status": "reset"}

In router.py:
- Use APIRouter with prefix="/api/rules" and tags=["rules"]
- Validate document_type with Literal type
- Return 404 if invalid document type

Update main.py:
- Import router from app.config.router
- Add app.include_router(config_router)
  </action>
  <verify>
python -c "
from app.config.router import router
from app.main import app
# Verify router is registered
routes = [r.path for r in app.routes]
assert '/api/rules/{document_type}' in routes, f'Rules route not found in {routes}'
print('Router registered correctly')
"
  </verify>
  <done>All three endpoints work correctly and return proper responses</done>
</task>

<task type="auto">
  <name>Task 3: Add user_config to .gitignore</name>
  <files>
    backend/.gitignore
  </files>
  <action>
Add user_config directory contents to .gitignore (but keep .gitkeep):

```
# User configuration (per-user overrides)
user_config/*
!user_config/.gitkeep
```

If .gitignore doesn't exist, create it with common Python ignores plus the user_config rule.
  </action>
  <verify>
python -c "
from pathlib import Path
gitignore = Path('backend/.gitignore').read_text() if Path('backend/.gitignore').exists() else ''
assert 'user_config' in gitignore, 'user_config not in .gitignore'
print('.gitignore contains user_config rule')
"
  </verify>
  <done>.gitignore updated to exclude user override files</done>
</task>

</tasks>

<verification>
1. RuleService loads and merges rules correctly
2. GET endpoint returns merged rules for all 5 document types
3. PUT endpoint saves overrides (verify by checking user_config/ directory)
4. POST reset endpoint removes override file
5. Server starts without errors with new router
</verification>

<success_criteria>
- All 3 REST endpoints functional
- Atomic file writes prevent corruption
- User overrides stored separately from templates
- API follows existing patterns (router prefix, error handling)
</success_criteria>

<output>
After completion, create `.planning/phases/02-rule-configuration-engine/02-02-SUMMARY.md`
</output>
