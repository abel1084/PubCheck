---
phase: 04-ai-verification
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - frontend/src/types/checks.ts
  - frontend/src/types/ai.ts
  - frontend/src/hooks/useAIAnalysis.ts
  - frontend/src/components/CheckResults/IssueCard.tsx
  - frontend/src/components/CheckResults/CheckResults.css
  - frontend/src/components/CheckResults/AIProgress.tsx
  - frontend/src/components/CheckResults/CheckResults.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User sees extraction data immediately, AI results appear when ready"
    - "Progress indicator shows page counter during analysis"
    - "Confidence indicator appears for medium/low confidence findings"
    - "Reasoning section is expandable, one sentence"
  artifacts:
    - path: "frontend/src/types/ai.ts"
      provides: "TypeScript types for AI analysis"
      exports: ["AIFinding", "PageAnalysisResult", "DocumentAnalysisResult"]
    - path: "frontend/src/hooks/useAIAnalysis.ts"
      provides: "Hook for AI analysis API"
      exports: ["useAIAnalysis"]
    - path: "frontend/src/components/CheckResults/AIProgress.tsx"
      provides: "Progress indicator component"
      exports: ["AIProgress"]
  key_links:
    - from: "frontend/src/hooks/useAIAnalysis.ts"
      to: "/api/ai/analyze"
      via: "fetch POST with FormData"
      pattern: "fetch.*api/ai/analyze"
    - from: "frontend/src/components/CheckResults/IssueCard.tsx"
      to: "frontend/src/types/checks.ts"
      via: "CheckIssue type with AI fields"
      pattern: "ai_confidence|ai_reasoning"
---

<objective>
Integrate AI analysis into frontend with progress indicator and confidence display.

Purpose: Provides user-facing AI analysis with progressive loading, confidence indicators, and expandable reasoning.

Output: AI analysis integrated into Check Results UI with progress tracking and confidence badges.
</objective>

<execution_context>
@C:\Users\abelb\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abelb\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/LEARNINGS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-verification/04-CONTEXT.md
@.planning/phases/04-ai-verification/04-02-SUMMARY.md
@frontend/src/types/checks.ts
@frontend/src/hooks/useComplianceCheck.ts
@frontend/src/components/CheckResults/IssueCard.tsx
@frontend/src/components/CheckResults/CheckResults.tsx
@frontend/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI types and extend CheckIssue</name>
  <files>frontend/src/types/ai.ts, frontend/src/types/checks.ts</files>
  <action>
Create TypeScript types for AI analysis responses.

**ai.ts:**
```typescript
/**
 * TypeScript types for AI analysis results.
 * Mirrors backend/app/ai/schemas.py
 */

export interface AIFinding {
  check_name: string;
  passed: boolean;
  confidence: 'high' | 'medium' | 'low';
  message: string;
  reasoning?: string;
  location?: string;
  suggestion?: string;
}

export interface PageAnalysisResult {
  page_number: number;
  findings: AIFinding[];
  error?: string;
}

export interface DocumentAnalysisResult {
  page_results: PageAnalysisResult[];
  document_summary?: string;
  total_findings: number;
  analysis_duration_ms: number;
}
```

**checks.ts updates:**
Add AI fields to CheckIssue interface:
```typescript
export interface CheckIssue {
  // ... existing fields ...

  // AI analysis fields
  ai_verified?: boolean;
  ai_confidence?: 'high' | 'medium' | 'low';
  ai_reasoning?: string;
}
```
  </action>
  <verify>
```bash
cd frontend && npx tsc --noEmit 2>&1 | head -20
```
  </verify>
  <done>AI types defined and CheckIssue extended with AI fields</done>
</task>

<task type="auto">
  <name>Task 2: Create useAIAnalysis hook</name>
  <files>frontend/src/hooks/useAIAnalysis.ts</files>
  <action>
Create hook for AI analysis API calls.

**useAIAnalysis.ts:**
```typescript
import { useState, useCallback } from 'react';
import type { DocumentAnalysisResult } from '../types/ai';
import type { ExtractionResult } from '../types/extraction';

interface UseAIAnalysisReturn {
  isAnalyzing: boolean;
  progress: string;  // "Analyzing page 3 of 12..."
  aiResult: DocumentAnalysisResult | null;
  aiError: string | null;
  analyze: (file: File, extraction: ExtractionResult, documentType: string) => Promise<void>;
  reset: () => void;
}

export function useAIAnalysis(): UseAIAnalysisReturn {
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [progress, setProgress] = useState('');
  const [aiResult, setAIResult] = useState<DocumentAnalysisResult | null>(null);
  const [aiError, setAIError] = useState<string | null>(null);

  const analyze = useCallback(async (
    file: File,
    extraction: ExtractionResult,
    documentType: string
  ) => {
    setIsAnalyzing(true);
    setProgress('Starting AI analysis...');
    setAIError(null);
    setAIResult(null);

    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('extraction', JSON.stringify(extraction));
      formData.append('document_type', documentType);

      // Progress updates via polling or SSE could be added later
      // For now, show generic progress
      const pageCount = extraction.pages.length;
      setProgress(`Analyzing ${pageCount} page${pageCount > 1 ? 's' : ''}...`);

      const response = await fetch('/api/ai/analyze', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'AI analysis failed');
      }

      const result: DocumentAnalysisResult = await response.json();
      setAIResult(result);
      setProgress('');
    } catch (err) {
      setAIError(err instanceof Error ? err.message : 'AI analysis failed');
      setProgress('');
    } finally {
      setIsAnalyzing(false);
    }
  }, []);

  const reset = useCallback(() => {
    setIsAnalyzing(false);
    setProgress('');
    setAIResult(null);
    setAIError(null);
  }, []);

  return { isAnalyzing, progress, aiResult, aiError, analyze, reset };
}
```
  </action>
  <verify>
```bash
cd frontend && npx tsc --noEmit 2>&1 | head -20
```
  </verify>
  <done>useAIAnalysis hook manages API calls with progress state</done>
</task>

<task type="auto">
  <name>Task 3: Create AIProgress component and update IssueCard</name>
  <files>frontend/src/components/CheckResults/AIProgress.tsx, frontend/src/components/CheckResults/IssueCard.tsx, frontend/src/components/CheckResults/CheckResults.css</files>
  <action>
Create progress indicator and update IssueCard for AI fields.

**AIProgress.tsx:**
```typescript
interface AIProgressProps {
  progress: string;
  isAnalyzing: boolean;
}

export function AIProgress({ progress, isAnalyzing }: AIProgressProps) {
  if (!isAnalyzing && !progress) return null;

  return (
    <div className="ai-progress">
      {isAnalyzing && <span className="ai-progress__spinner" />}
      <span className="ai-progress__text">{progress}</span>
    </div>
  );
}
```

**IssueCard.tsx updates:**
- Add confidence indicator for medium/low confidence:
  - Icon (warning triangle) + tooltip showing confidence level
  - Only show for medium/low, high is assumed
- Add muted styling for low-confidence findings
- Add expandable reasoning section (inside existing details):
  - Show only if ai_reasoning exists
  - One sentence, includes suggestion if present

**CheckResults.css additions:**
```css
/* AI Progress */
.ai-progress {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: var(--bg-secondary);
  border-radius: 4px;
  margin-bottom: 16px;
}

.ai-progress__spinner {
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.ai-progress__text {
  color: var(--text-secondary);
  font-size: 14px;
}

/* Confidence indicator */
.issue-card__confidence {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: var(--text-secondary);
}

.issue-card__confidence--low {
  color: var(--warning);
}

.issue-card__confidence--medium {
  color: var(--text-secondary);
}

/* Low confidence muted styling */
.issue-card--low-confidence {
  opacity: 0.7;
}

/* AI reasoning section */
.issue-card__reasoning {
  margin-top: 8px;
  padding: 8px;
  background: var(--bg-secondary);
  border-radius: 4px;
  font-size: 13px;
  color: var(--text-secondary);
}
```
  </action>
  <verify>
```bash
cd frontend && npx tsc --noEmit 2>&1 | head -20
```
  </verify>
  <done>AIProgress shows page counter, IssueCard displays confidence and reasoning</done>
</task>

<task type="auto">
  <name>Task 4: Integrate AI analysis into App and CheckResults</name>
  <files>frontend/src/App.tsx, frontend/src/components/CheckResults/CheckResults.tsx, frontend/src/components/CheckResults/index.ts</files>
  <action>
Wire up AI analysis to application flow.

**App.tsx updates:**
- Import useAIAnalysis hook
- Add "Analyze with AI" button next to existing "Check" button
  - Green outline style (complementary to Check button)
  - Disabled until extraction exists
  - Shows spinner when analyzing
- Pass aiResult and isAnalyzing to CheckResults component
- Store uploaded File object in state for AI analysis
- Re-analyze button: calls analyze() with current file/extraction

**CheckResults.tsx updates:**
- Accept new props: aiResult, isAnalyzing, progress, aiError
- Show AIProgress component above findings when analyzing
- Merge AI findings into results display:
  - Create "AI Analysis" category/section at bottom
  - Convert AIFinding to CheckIssue format for display
  - Pass ai_verified=true, ai_confidence, ai_reasoning
- Show document_summary if present (after all categories)
- Show AI errors in error banner

**index.ts:**
- Export AIProgress component
  </action>
  <verify>
```bash
cd frontend && npm run build 2>&1 | tail -10
```
  </verify>
  <done>AI analysis button in App, results integrated into CheckResults</done>
</task>

</tasks>

<verification>
Frontend builds and AI components render:
```bash
cd frontend && npm run build
# Check for AI-related exports
grep -r "AIProgress\|useAIAnalysis" src/ --include="*.ts" --include="*.tsx" | head -10
```
</verification>

<success_criteria>
1. TypeScript types match backend AI schemas
2. useAIAnalysis hook manages analysis state and API calls
3. AIProgress shows "Analyzing page X of Y..." during analysis
4. IssueCard shows confidence indicator for medium/low confidence
5. IssueCard shows expandable reasoning section
6. Low-confidence findings have muted styling
7. App has "Analyze with AI" button that triggers analysis
8. CheckResults displays AI findings in dedicated section
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-verification/04-03-SUMMARY.md`
</output>
