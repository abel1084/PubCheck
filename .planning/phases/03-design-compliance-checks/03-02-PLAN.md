---
phase: 03-design-compliance-checks
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/app/checks/handlers/__init__.py
  - backend/app/checks/handlers/position.py
  - backend/app/checks/handlers/range.py
  - backend/app/checks/handlers/font.py
  - backend/app/checks/handlers/regex.py
  - backend/app/checks/handlers/presence.py
  - backend/app/checks/handlers/color.py
  - backend/app/checks/executor.py
autonomous: true

must_haves:
  truths:
    - "User sees margin issues only when content too close to edge (minimum-only)"
    - "User sees DPI issues with 2.5% tolerance applied (292 DPI passes for 300 DPI rule)"
    - "User sees typography issues with font names matched flexibly (Roboto matches AAAAAA+Roboto)"
    - "User sees required element issues when ISBN, DOI, disclaimer, or copyright missing"
    - "User sees issues with correct severity levels and page numbers"
    - "User sees color space issues when image not in expected RGB or CMYK format"
  artifacts:
    - path: "backend/app/checks/handlers/range.py"
      provides: "Margin and DPI range checks"
      exports: ["check_range"]
    - path: "backend/app/checks/handlers/regex.py"
      provides: "Required element text searches"
      exports: ["check_regex"]
    - path: "backend/app/checks/handlers/font.py"
      provides: "Typography font/size/weight checks"
      exports: ["check_font"]
    - path: "backend/app/checks/handlers/position.py"
      provides: "Logo position/size checks"
      exports: ["check_position"]
    - path: "backend/app/checks/handlers/presence.py"
      provides: "Element presence checks"
      exports: ["check_presence"]
    - path: "backend/app/checks/handlers/color.py"
      provides: "Color matching checks"
      exports: ["check_color"]
  key_links:
    - from: "backend/app/checks/handlers/range.py"
      to: "backend/app/checks/tolerance.py"
      via: "imports tolerance functions"
      pattern: "from ..tolerance import"
    - from: "backend/app/checks/executor.py"
      to: "backend/app/checks/handlers/"
      via: "registers all 6 handlers"
      pattern: "executor.register.*check_"
---

<objective>
Implement the 6 check type handlers that execute compliance rules against extracted PDF data: position (logo placement), range (margins, DPI, sizes), font (typography), regex (required text patterns), presence (element existence), and color (color matching).

Purpose: These handlers are the core business logic that validates PDFs against UNEP design rules, consuming extraction data and rule configuration to produce structured issues.
Output: backend/app/checks/handlers/ module with 6 handler files, updated executor.py with registrations

## Requirement Mapping

This plan's handlers cover all 21 Phase 3 requirements:

| Handler | Requirements Covered |
|---------|---------------------|
| **range.py** | MRGN-01, MRGN-02, MRGN-03, MRGN-04 (margins), IMAG-01 (DPI) |
| **font.py** | TYPO-01, TYPO-02, TYPO-03, TYPO-04, TYPO-05 (all typography) |
| **position.py** | COVR-01 (logo position/size), COVR-04 (partner logo placement) |
| **regex.py** | REQD-01 (ISBN), REQD-02 (DOI), REQD-03 (job number), REQD-04 (disclaimer), REQD-05 (copyright) |
| **presence.py** | REQD-06 (SDG icons count), COVR-02 (title presence), COVR-03 (subtitle presence) |
| **color.py** | IMAG-02 (color space validation - RGB/CMYK checks) |

Note: COVR-02 and COVR-03 typography validation uses font.py for font/size checks; presence.py confirms element existence.
</objective>

<execution_context>
@C:\Users\abelb\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abelb\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/LEARNINGS.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/03-design-compliance-checks/03-CONTEXT.md
@.planning/phases/03-design-compliance-checks/03-RESEARCH.md
@.planning/phases/03-design-compliance-checks/03-01-SUMMARY.md

@backend/app/models/extraction.py
@backend/app/config/models.py
@backend/app/checks/models.py
@backend/app/checks/tolerance.py
@backend/templates/factsheet.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create range and regex handlers</name>
  <files>backend/app/checks/handlers/__init__.py, backend/app/checks/handlers/range.py, backend/app/checks/handlers/regex.py</files>
  <action>
Create backend/app/checks/handlers/ module:

1. Create `__init__.py` exporting all handlers

2. Create `range.py` - handles margin and DPI checks (MRGN-*, IMAG-01):
```python
def check_range(extraction: ExtractionResult, rule: Rule, expected: RuleExpected) -> List[CheckIssue]:
```

Logic:
- Parse expected.dict() for min, max, unit
- If unit == "mm": Check margins
  - Determine which margin (top/bottom/inside/outside) from rule.name
  - Per CONTEXT.md: Check minimum only - flag when content too close to edge
  - Use `points_to_mm()` to convert margin values
  - Return issue if actual < min
- If unit == "pt": Check font sizes (delegate to font handler or handle inline)
- If unit == "dpi": Check image DPI
  - Use `check_dpi_minimum()` with 2.5% tolerance
  - Return issue for each low-DPI image with page number
  - Include "how_to_fix: Replace with higher resolution image"

3. Create `regex.py` - handles required element checks (REQD-01 to REQD-05):
```python
def check_regex(extraction: ExtractionResult, rule: Rule, expected: RuleExpected) -> List[CheckIssue]:
```

Logic:
- Get pattern from expected.dict()["pattern"]
- Build full document text from all text_blocks
- Also include metadata (isbn, doi, job_number) in search text
- Use `normalize_text_for_matching()` for comparison
- Compile regex with re.IGNORECASE | re.DOTALL
- If pattern not found: Return issue with "Required element not found"
- If found: Return empty list (no issue)

Handle invalid regex patterns gracefully - return error issue instead of crashing.
  </action>
  <verify>python -c "from app.checks.handlers import check_range, check_regex; print('Range and regex handlers imported OK')"</verify>
  <done>range.py checks margins with minimum-only logic and DPI with 2.5% tolerance; regex.py searches for patterns with text normalization</done>
</task>

<task type="auto">
  <name>Task 2: Create font, position, presence, and color handlers</name>
  <files>backend/app/checks/handlers/font.py, backend/app/checks/handlers/position.py, backend/app/checks/handlers/presence.py, backend/app/checks/handlers/color.py</files>
  <action>
Create remaining 4 handlers:

1. Create `font.py` - handles typography checks (TYPO-*):
```python
def check_font(extraction: ExtractionResult, rule: Rule, expected: RuleExpected) -> List[CheckIssue]:
```

Logic:
- Parse expected for: family, sizes (min/max), weights
- Use `normalize_font_name()` on both expected and actual font names
- Check if normalized actual font starts with or contains expected family
- For size range: Use `check_font_size_range()` with 0.5pt tolerance
- Group issues by type and page
- Note: For body text checks, look at majority of text blocks (not headers)
- For heading checks, look at larger text sizes

2. Create `position.py` - handles logo position checks (COVR-01, COVR-04):
```python
def check_position(extraction: ExtractionResult, rule: Rule, expected: RuleExpected) -> List[CheckIssue]:
```

Logic:
- Parse expected for: position (e.g., "top-right"), min_size_mm, target_size_mm
- For cover checks, focus on page 0 (first page)
- Find images in the expected region (top-right = high y, high x on page)
- Check image dimensions meet size requirements using `check_logo_size()` with 1mm tolerance
- Note: Full logo detection requires Phase 4 AI - this is positional heuristic only
- Return issue if no image found in expected position or size too small

3. Create `presence.py` - handles element presence checks (REQD-06 for SDG icons):
```python
def check_presence(extraction: ExtractionResult, rule: Rule, expected: RuleExpected) -> List[CheckIssue]:
```

Logic:
- Parse expected for: required (bool), count (optional min/max)
- For SDG icon count: Count images on last page in expected size range
- Note: Full SDG detection requires Phase 4 AI - this counts likely candidates
- Return issue if count outside expected range (1-3 per REQD-06)

4. Create `color.py` - handles color matching AND color space checks (IMAG-02):
```python
def check_color(extraction: ExtractionResult, rule: Rule, expected: RuleExpected) -> List[CheckIssue]:
```

Logic:
- Parse expected for: hex (color code), tolerance (default 5), OR color_space ("RGB", "CMYK")
- For color matching (text colors):
  - Find text blocks matching the context (e.g., title text for title color)
  - Use `check_color_match()` to compare colors
  - Return issue if color doesn't match with tolerance
- For color space validation (IMAG-02):
  - Check image color spaces against expected (RGB or CMYK as specified in rule)
  - Iterate extraction.images, check each image's color_space field
  - Return issue for each image with wrong color space, including page number
  - Message: "Image has {actual} color space, expected {expected}"
  </action>
  <verify>python -c "from app.checks.handlers import check_font, check_position, check_presence, check_color; print('All 6 handlers imported OK')"</verify>
  <done>Font handler normalizes names and checks size ranges; position checks logo placement; presence counts elements; color matches with tolerance</done>
</task>

<task type="auto">
  <name>Task 3: Register all handlers in executor</name>
  <files>backend/app/checks/executor.py, backend/app/checks/handlers/__init__.py</files>
  <action>
Update executor.py to import and register all 6 handlers:

```python
from .handlers import (
    check_position,
    check_range,
    check_font,
    check_regex,
    check_presence,
    check_color,
)

def create_executor() -> CheckExecutor:
    """Create executor with all handlers registered."""
    executor = CheckExecutor()
    executor.register("position", check_position)
    executor.register("range", check_range)
    executor.register("font", check_font)
    executor.register("regex", check_regex)
    executor.register("presence", check_presence)
    executor.register("color", check_color)
    return executor
```

Update handlers/__init__.py to export all handlers for clean imports.
  </action>
  <verify>python -c "from app.checks.executor import create_executor; e = create_executor(); print(f'Registered handlers: {list(e._handlers.keys())}')"</verify>
  <done>create_executor() registers all 6 handlers: position, range, font, regex, presence, color</done>
</task>

</tasks>

<verification>
Run from backend directory:
```bash
cd backend
python -c "
from app.checks.executor import create_executor
from app.checks.handlers import check_range, check_regex, check_font

executor = create_executor()
handlers = list(executor._handlers.keys())
print(f'Registered handlers: {handlers}')

# Verify all 6 handlers
expected = ['position', 'range', 'font', 'regex', 'presence', 'color']
for h in expected:
    assert h in handlers, f'Missing handler: {h}'

print('All 6 handlers registered successfully!')
"
```
</verification>

<success_criteria>
1. All 6 handler files exist in backend/app/checks/handlers/
2. Range handler implements minimum-only margin checks and 2.5% DPI tolerance
3. Regex handler normalizes text and searches patterns case-insensitively
4. Font handler normalizes font names and checks size ranges with 0.5pt tolerance
5. Position handler checks logo placement on first page
6. Presence handler counts elements (SDG icons)
7. Color handler matches colors with per-channel tolerance
8. Executor registers all 6 handlers
</success_criteria>

<output>
After completion, create `.planning/phases/03-design-compliance-checks/03-02-SUMMARY.md`
</output>
