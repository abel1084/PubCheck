---
phase: 01-pdf-foundation-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/__init__.py
  - backend/app/main.py
  - backend/app/models/extraction.py
  - backend/app/services/pdf_extractor.py
  - backend/app/services/text_processor.py
  - backend/app/services/image_processor.py
  - backend/app/services/margin_calculator.py
  - backend/requirements.txt
  - frontend/package.json
  - frontend/src/main.tsx
  - frontend/src/App.tsx
  - frontend/src/types/extraction.ts
  - frontend/vite.config.ts
  - frontend/tsconfig.json
  - frontend/index.html
autonomous: true

must_haves:
  truths:
    - "Backend server starts without errors on localhost:8000"
    - "Frontend dev server starts without errors on localhost:5173"
    - "PDF extraction service can extract text with font info from a PDF"
    - "PDF extraction service can extract images with DPI from a PDF"
    - "PDF extraction service can calculate page margins from a PDF"
    - "PDF extraction service can extract document metadata from a PDF"
  artifacts:
    - path: "backend/app/main.py"
      provides: "FastAPI application entry point"
      contains: "FastAPI"
    - path: "backend/app/services/pdf_extractor.py"
      provides: "PyMuPDF extraction orchestration"
      exports: ["PDFExtractor", "extract_document"]
    - path: "backend/app/models/extraction.py"
      provides: "Pydantic models for extraction data"
      exports: ["TextBlock", "ImageInfo", "PageMargins", "DocumentMetadata", "ExtractionResult"]
    - path: "frontend/src/types/extraction.ts"
      provides: "TypeScript types matching backend models"
      exports: ["TextBlock", "ImageInfo", "PageMargins", "DocumentMetadata", "ExtractionResult"]
  key_links:
    - from: "backend/app/services/pdf_extractor.py"
      to: "pymupdf"
      via: "import pymupdf"
      pattern: "import pymupdf"
    - from: "backend/app/services/pdf_extractor.py"
      to: "backend/app/models/extraction.py"
      via: "model imports"
      pattern: "from app.models.extraction import"
---

<objective>
Create project scaffolding for PubCheck with FastAPI backend and React frontend, then implement the core PDF extraction service using PyMuPDF.

Purpose: Establish the foundation for all subsequent Phase 1 work. The extraction service is the core engine that all other features depend on.

Output: Working backend/frontend project structure with a complete PDF extraction service that can extract text (with fonts/coordinates), images (with DPI), margins, and metadata.
</objective>

<execution_context>
@C:\Users\abelb\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\abelb\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/LEARNINGS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-pdf-foundation-extraction/01-CONTEXT.md
@.planning/phases/01-pdf-foundation-extraction/01-RESEARCH.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project scaffolding</name>
  <files>
    backend/app/__init__.py
    backend/app/main.py
    backend/requirements.txt
    frontend/package.json
    frontend/src/main.tsx
    frontend/src/App.tsx
    frontend/vite.config.ts
    frontend/tsconfig.json
    frontend/index.html
  </files>
  <action>
Create the project structure as specified in ARCHITECTURE.md:

**Backend (Python/FastAPI):**
1. Create `backend/` directory with `app/` subdirectory
2. Create `backend/requirements.txt` with:
   - pymupdf==1.26.7
   - fastapi==0.115.6
   - uvicorn[standard]==0.32.1
   - python-multipart==0.0.18
   - pydantic==2.10.0
   - aiofiles==24.1.0
   - pillow==11.0.0
3. Create `backend/app/__init__.py` (empty)
4. Create `backend/app/main.py` with FastAPI app:
   - CORS middleware configured for localhost:5173
   - Health check endpoint at GET /
   - Static files mount placeholder
   - Uvicorn run block for `if __name__ == "__main__"`

**Frontend (React/TypeScript/Vite):**
1. Create `frontend/` directory
2. Create `frontend/package.json` with:
   - react, react-dom (18.x)
   - react-dropzone (14.3.x)
   - @tanstack/react-table (8.21.x)
   - typescript, vite, @vitejs/plugin-react
   - @types/react, @types/react-dom
3. Create `frontend/vite.config.ts` with React plugin and proxy to backend:8000
4. Create `frontend/tsconfig.json` with strict mode
5. Create `frontend/index.html` with root div
6. Create `frontend/src/main.tsx` with ReactDOM.createRoot
7. Create `frontend/src/App.tsx` with placeholder "PubCheck" heading

Do NOT run npm install or pip install yet - just create the files.
  </action>
  <verify>
- All files exist in correct locations
- `python -c "import ast; ast.parse(open('backend/app/main.py').read())"` succeeds (valid Python)
- `cat frontend/package.json | python -c "import sys,json; json.load(sys.stdin)"` succeeds (valid JSON)
  </verify>
  <done>
- Backend structure exists: backend/app/main.py, backend/requirements.txt
- Frontend structure exists: frontend/package.json, frontend/src/App.tsx
- Both can be parsed without syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement PDF extraction service with Pydantic models</name>
  <files>
    backend/app/models/__init__.py
    backend/app/models/extraction.py
    backend/app/services/__init__.py
    backend/app/services/pdf_extractor.py
    backend/app/services/text_processor.py
    backend/app/services/image_processor.py
    backend/app/services/margin_calculator.py
    frontend/src/types/extraction.ts
  </files>
  <action>
**Create Pydantic models** in `backend/app/models/extraction.py`:

```python
from pydantic import BaseModel
from typing import Literal

class TextBlock(BaseModel):
    text: str
    font: str  # Normalized (subset prefix stripped)
    size: float
    bold: bool
    italic: bool
    color: int  # RGB as integer
    bbox: tuple[float, float, float, float]  # x0, y0, x1, y1
    page: int

class ImageInfo(BaseModel):
    xref: int
    width: int
    height: int
    colorspace: str
    dpi_x: float
    dpi_y: float
    bbox: tuple[float, float, float, float]
    page: int
    has_mask: bool

class PageMargins(BaseModel):
    page: int
    top: float  # Points (72 points = 1 inch)
    bottom: float
    left: float
    right: float
    # Inside/outside derived from odd/even page
    inside: float
    outside: float

class DocumentMetadata(BaseModel):
    filename: str
    page_count: int
    title: str | None
    author: str | None
    creation_date: str | None
    producer: str | None
    isbn: str | None
    doi: str | None
    job_number: str | None

class FontSummary(BaseModel):
    name: str
    count: int
    pages: list[int]

class ExtractionResult(BaseModel):
    metadata: DocumentMetadata
    text_blocks: list[TextBlock]
    images: list[ImageInfo]
    margins: list[PageMargins]
    fonts: list[FontSummary]
```

**Create text processor** in `backend/app/services/text_processor.py`:
- `normalize_font_name(font_name: str) -> str`: Strip subset prefix (BAAAAA+Arial -> Arial)
- `decode_font_flags(flags: int) -> dict`: Extract bold, italic from bit flags (16=bold, 2=italic)
- `extract_text_blocks(page, page_num: int) -> list[TextBlock]`: Use get_text("dict", sort=True), process blocks/lines/spans

**Create image processor** in `backend/app/services/image_processor.py`:
- `extract_images(doc, page, page_num: int) -> list[ImageInfo]`: Use get_images(full=True), calculate DPI from bbox

**Create margin calculator** in `backend/app/services/margin_calculator.py`:
- `calculate_margins(page, page_num: int) -> PageMargins`: Find content bounding box, calculate margins, derive inside/outside from odd/even

**Create PDF extractor** in `backend/app/services/pdf_extractor.py`:
- `class PDFExtractor`: Orchestrates extraction
  - `__init__(self, file_bytes: bytes, filename: str)`
  - `extract(self) -> ExtractionResult`: Calls all processors, aggregates results
  - `_extract_metadata(self) -> DocumentMetadata`: Get doc.metadata plus ISBN/DOI/job regex from first 3 pages
  - `_summarize_fonts(self, text_blocks: list[TextBlock]) -> list[FontSummary]`: Group by font name

**Create TypeScript types** in `frontend/src/types/extraction.ts`:
Mirror all Pydantic models as TypeScript interfaces.

Follow patterns from RESEARCH.md exactly - use sort=True, strip font prefixes, calculate DPI from bbox not embedded values.
  </action>
  <verify>
- Install deps: `cd backend && pip install -r requirements.txt`
- Run: `cd backend && python -c "from app.services.pdf_extractor import PDFExtractor; from app.models.extraction import ExtractionResult; print('Imports OK')"`
- If you have a test PDF: `cd backend && python -c "from app.services.pdf_extractor import PDFExtractor; import pathlib; pdf = pathlib.Path('test.pdf'); e = PDFExtractor(pdf.read_bytes(), 'test.pdf') if pdf.exists() else print('No test PDF')"`
  </verify>
  <done>
- All model classes defined and importable
- PDFExtractor.extract() returns ExtractionResult with text_blocks, images, margins, metadata, fonts
- Font names are normalized (no subset prefixes)
- DPI calculated from rendered size, not embedded metadata
- TypeScript types match Python models
  </done>
</task>

</tasks>

<verification>
1. Backend starts: `cd backend && pip install -r requirements.txt && python -m uvicorn app.main:app --reload`
   - Should show "Uvicorn running on http://127.0.0.1:8000"
   - GET http://localhost:8000/ returns health response

2. Frontend starts: `cd frontend && npm install && npm run dev`
   - Should show "VITE v5.x.x ready in X ms"
   - Browser at http://localhost:5173 shows "PubCheck" heading

3. Extraction service works: Create a simple test script that loads a PDF and extracts content
</verification>

<success_criteria>
- Backend server runs on localhost:8000
- Frontend dev server runs on localhost:5173
- PDFExtractor can extract text with font info, images with DPI, margins, and metadata
- All Pydantic models validate correctly
- TypeScript types exist and match Python models
</success_criteria>

<output>
After completion, create `.planning/phases/01-pdf-foundation-extraction/01-01-SUMMARY.md`
</output>
