---
phase: "07.1"
plan: "04"
subsystem: "ai-review"
tags: ["json-output", "comment-list", "pdf-annotation", "tabs"]

dependency-graph:
  requires: ["07.1-03"]
  provides: ["structured-issues", "comment-selection", "pdf-generation"]
  affects: ["07.1-05"]

tech-stack:
  added: []
  patterns:
    - "JSON block parsing from AI response"
    - "Tab navigation with conditional rendering"
    - "Checkbox selection with indeterminate state"

key-files:
  created:
    - "frontend/src/components/CommentList/CommentList.tsx"
    - "frontend/src/components/CommentList/CommentList.css"
  modified:
    - "backend/app/ai/prompts.py"
    - "frontend/src/types/review.ts"
    - "frontend/src/hooks/useAIReview.ts"
    - "frontend/src/App.tsx"
    - "frontend/src/App.css"

decisions:
  - decision: "Select all issues by default"
    rationale: "Users more likely to want all issues included, can deselect unwanted"
  - decision: "Map needs_attention to error, suggestion to warning"
    rationale: "Matches existing annotation severity levels for consistent PDF output"

metrics:
  duration: "6 min"
  completed: "2026-02-01"
---

# Phase 7.1 Plan 04: Structured JSON Output for Comment List

Structured JSON parsing from AI responses with selectable Comment List tab for PDF annotation.

## One-liner

JSON block extraction from AI response with tabbed Comment List for selective PDF annotation.

## What Was Built

### 1. Prompt Update for JSON Output (Task 1)
- Added Output Format section to SYSTEM_PROMPT_TEMPLATE
- AI now produces prose review followed by structured JSON block
- JSON schema: `{ issues: [{ id, category, title, description, pages }] }`
- Category values: `needs_attention` or `suggestion`

### 2. JSON Parsing in useAIReview (Task 2)
- Added `ReviewIssue` interface to types/review.ts
- Added `issues: ReviewIssue[]` to AIReviewState
- Created `parseReviewIssues()` function to extract JSON from markdown code blocks
- Parsing occurs when streaming completes (not during)

### 3. CommentList Component (Task 3)
- Collapsible sections: "Needs Attention" and "Suggestions"
- Each item: checkbox, title, page badge, expand button
- Section-level checkbox with indeterminate state for partial selection
- Expandable description for full issue details
- Generate PDF button in footer with count

### 4. Tab Navigation (Task 4)
- Added tabs above ReviewResults: "Design Review" | "Comment List"
- Tab switching with activeTab state
- Comment List tab disabled when no issues
- Badge showing issue count

### 5. PDF Generation Wiring (Task 5)
- Convert ReviewIssue to IssueAnnotation format
- Map category to severity for annotation colors
- Call /api/output/annotate with selected issues
- Download annotated PDF with toast notification

## Verification

- [x] Prompt requests JSON block after prose sections
- [x] JSON parsed from response when streaming completes
- [x] CommentList shows grouped issues with selection
- [x] Tab navigation works between Review and Comments
- [x] Generate PDF button creates annotated document

## Commits

| Hash | Type | Description |
|------|------|-------------|
| a693f95 | feat | update prompt for JSON + prose output |
| c65639f | feat | parse JSON issues from AI response |
| e246542 | feat | create CommentList component |
| f3b2f85 | feat | add Comment List tab to main view |
| 8d61b3b | feat | wire selected issues to PDF annotation |

## Deviations from Plan

None - plan executed exactly as written.

## Files Changed

### Created
- `frontend/src/components/CommentList/CommentList.tsx` - Selectable issue list component
- `frontend/src/components/CommentList/CommentList.css` - Styling with attention/suggestions variants

### Modified
- `backend/app/ai/prompts.py` - Added Output Format section for JSON block
- `frontend/src/types/review.ts` - Added ReviewIssue, parseReviewIssues, updated AIReviewState
- `frontend/src/hooks/useAIReview.ts` - Parse issues on stream complete
- `frontend/src/App.tsx` - Tab state, selection state, PDF generation handler
- `frontend/src/App.css` - Tab styling and output format dropdown

## Next Phase Readiness

Ready for 07.1-05 (User Verification). Features to verify:
1. AI response includes JSON block at end
2. Comment List tab appears after review completes
3. Issues can be selected/deselected individually or by section
4. Generate PDF creates annotated document with selected issues
