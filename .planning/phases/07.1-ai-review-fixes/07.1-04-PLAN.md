---
phase: 07.1-ai-review-fixes
plan: 04
type: execute
depends_on: ["07.1-03"]
autonomous: true
---

<objective>
Add structured JSON output alongside prose for Comment List tab.

1. Update prompt to request JSON block at end of response
2. Parse JSON from streamed response
3. Create Comment List tab with selectable items
4. Wire selected items to PDF annotation
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Update prompt for JSON + prose output</name>
  <files>backend/app/ai/prompts.py</files>
  <action>
Add to SYSTEM_PROMPT_TEMPLATE response structure section:

```
## Output Format

First, provide your prose review using the section headers (Overview, Needs Attention, Looking Good, Suggestions).

Then, at the very end, provide a JSON block with structured issues for the comment system:

\`\`\`json
{
  "issues": [
    {
      "id": "issue-1",
      "category": "needs_attention" | "suggestion",
      "title": "Brief issue title",
      "description": "Full description with measurements",
      "pages": [1, 2]
    }
  ]
}
\`\`\`

The JSON block must come AFTER all prose content.
```
  </action>
  <done>Prompt requests JSON block</done>
</task>

<task type="auto">
  <name>Task 2: Parse JSON from response in useAIReview</name>
  <files>frontend/src/hooks/useAIReview.ts, frontend/src/types/review.ts</files>
  <action>
Add ReviewIssue type:
```typescript
interface ReviewIssue {
  id: string;
  category: 'needs_attention' | 'suggestion';
  title: string;
  description: string;
  pages: number[];
}
```

Update useAIReview to:
1. Detect JSON block at end of content (after streaming completes)
2. Parse issues array
3. Add `issues: ReviewIssue[]` to state
  </action>
  <done>JSON parsed from response</done>
</task>

<task type="auto">
  <name>Task 3: Create CommentList component</name>
  <files>
    frontend/src/components/CommentList/CommentList.tsx
    frontend/src/components/CommentList/CommentList.css
  </files>
  <action>
Create CommentList component:
- Collapsible sections: "Needs Attention", "Suggestions"
- Each item: checkbox, title, pages badge
- Track selected items via callback
- Expand item to show full description

Props:
- issues: ReviewIssue[]
- selectedIds: Set<string>
- onToggleSelect: (id: string) => void
  </action>
  <done>CommentList component created</done>
</task>

<task type="auto">
  <name>Task 4: Add Comment List tab to main view</name>
  <files>frontend/src/App.tsx</files>
  <action>
Add tabs above ReviewResults:
- "Design Review" (current prose view)
- "Comment List" (new selectable list)

Add state:
- activeTab: 'review' | 'comments'
- selectedIssueIds: Set<string>

Wire CommentList with selection state.
  </action>
  <done>Comment List tab integrated</done>
</task>

<task type="auto">
  <name>Task 5: Wire selected issues to PDF annotation</name>
  <files>frontend/src/App.tsx</files>
  <action>
Update Generate PDF button to use selected issues from Comment List.
Pass selectedIssueIds to annotation endpoint.
  </action>
  <done>Selected issues feed PDF annotation</done>
</task>

</tasks>

<output>
Create 07.1-04-SUMMARY.md
</output>
